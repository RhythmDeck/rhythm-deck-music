<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rhythm Deck — Free Profile Admin</title>
<base href="/">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  .hover-change { opacity: 0; transition: opacity .2s; }
  .group:hover .hover-change { opacity: 1; }
  .play-overlay {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    font-size: 3rem; color: white; text-shadow: 0 0 10px black;
  }
  .video-card { position: relative; cursor: pointer; }
</style>
</head>
<body class="bg-gradient-to-br from-gray-100 to-gray-200 min-h-screen text-gray-900">

  <!-- HEADER -->
  <header class="bg-black text-white p-5 shadow-xl">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-4">
        <img src="logo-1-sm.jpg" alt="Logo" class="h-12 w-12 rounded-full border-2 border-emerald-500">
        <div>
          <div class="text-2xl font-black">RHYTHM DECK</div>
          <div class="text-sm text-emerald-400">Free Plan</div>
        </div>
      </div>
      <nav class="space-x-6 text-lg">
        <a href="index.html" class="hover:text-emerald-400">Home</a>
        <a id="previewLink" href="#" target="_blank" class="hover:text-emerald-400 font-bold">Preview Profile</a>
        <a href="pricing.html" class="bg-emerald-600 px-5 py-2 rounded-lg hover:bg-emerald-500 font-bold">Upgrade to Pro</a>
        <a href="logout.html" class="bg-white text-black px-5 py-2 rounded-lg font-bold hover:bg-gray-200">Logout</a>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-8">
    <div class="bg-white rounded-3xl shadow-2xl p-10">
      <!-- BANNER -->
      <div class="relative group rounded-2xl overflow-hidden mb-8">
        <img id="bannerPreview" src="banner-placeholder.jpg" alt="Banner" class="w-full h-64 object-cover">
        <input id="bannerInput" type="file" accept="image/*" class="hidden">
        <div class="hover-change absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center">
          <button class="bg-white text-black px-6 py-3 rounded-full font-bold text-lg shadow-lg hover:scale-110 transition">Change Banner</button>
        </div>
      </div>

      <div class="flex flex-col md:flex-row gap-10 items-start">
        <!-- LOGO -->
        <div class="relative group">
          <img id="logoPreview" src="logo-placeholder.png" alt="Logo" class="w-48 h-48 rounded-full object-cover border-8 border-white shadow-2xl">
          <input id="logoInput" type="file" accept="image/*" class="hidden">
          <div class="hover-change absolute inset-0 bg-black bg-opacity-60 rounded-full flex items-center justify-center">
            <button class="text-white text-5xl font-bold">+</button>
          </div>
        </div>

        <!-- INFO -->
        <div class="flex-1">
          <input id="creatorName" placeholder="Your Artist / Band Name" class="text-4xl font-black w-full border-b-4 border-emerald-500 pb-3 mb-6 focus:outline-none">

          <textarea id="bioInput" rows="5" placeholder="Tell your fans who you are..." class="w-full p-5 border-2 border-gray-300 rounded-2xl text-lg mb-6 focus:border-emerald-500 focus:outline-none"></textarea>

          <div class="flex flex-wrap gap-4 items-center">
            <button id="saveAllBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-black px-8 py-4 rounded-xl text-xl shadow-lg">Save All Changes</button>
            <button id="publishBtn" class="bg-gradient-to-r from-green-600 to-emerald-700 hover:from-green-700 hover:to-emerald-800 text-white font-black px-8 py-4 rounded-xl text-xl shadow-lg">Publish Profile</button>
            
            <div class="flex items-center gap-3 mt-4">
              <span class="font-bold text-lg">Your Link:</span>
              <input id="publicUrl" readonly class="border-2 border-emerald-500 rounded-lg px-4 py-3 font-mono text-emerald-700 bg-emerald-50 w-80">
              <button id="copyUrl" class="bg-emerald-600 text-white px-5 py-3 rounded-lg font-bold hover:bg-emerald-700">Copy</button>
            </div>
          </div>
        </div>
      </div>

      <!-- VIDEOS -->
      <div class="mt-16">
        <div class="flex justify-between items-center mb-8">
          <h3 class="text-3xl font-black text-emerald-800">Your Videos</h3>
          <button id="openAddModal" class="bg-black text-white px-6 py-4 rounded-xl font-bold text-lg hover:bg-gray-800">+ Add Video</button>
        </div>
        <div id="videoGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
      </div>
    </div>
  </main>

  <!-- ADD VIDEO MODAL -->
  <div id="addModal" class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-3xl p-10 w-full max-w-2xl shadow-2xl">
      <h3 class="text-3xl font-black mb-8 text-emerald-800">Upload New Video</h3>
      <div class="space-y-6">
        <div>
          <label class="block font-bold mb-2">Thumbnail Image</label>
          <input id="thumbFile" type="file" accept="image/*" class="w-full p-4 border-2 border-dashed rounded-xl">
        </div>
        <div>
          <label class="block font-bold mb-2">Video File (.mp4)</label>
          <input id="videoFile" type="file" accept="video/mp4" class="w-full p-4 border-2 border-dashed rounded-xl">
        </div>
        <div>
          <label class="block font-bold mb-2">Title (optional)</label>
          <input id="videoTitle" type="text" placeholder="My Awesome Song" class="w-full p-4 border rounded-xl">
        </div>
        <div class="flex gap-4">
          <button id="saveVideoBtn" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-black py-5 rounded-xl text-xl">Upload Video</button>
          <button id="cancelAdd" class="flex-1 bg-gray-300 hover:bg-gray-400 text-black font-bold py-5 rounded-xl text-xl">Cancel</button>
        </div>
        <div id="uploadLoader" class="hidden text-center text-emerald-600 font-bold text-xl">Uploading... Please wait</div>
      </div>
    </div>
  </div>

<script>
const supabase = window.supabase.createClient(
  "https://bxoqhmfnseskwqkywppg.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4b3FobWZuc2Vza3dxa3l3cHBnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5Mjk4MzgsImV4cCI6MjA3NjUwNTgzOH0.vnzlMkgkA0bOpFSw2JN_b3GjrxWK3S85yC1WGeoOUZc"
);

let userId = null;
let profile = null;

async function init() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) { window.location.href = 'login.html'; return; }
  userId = user.id;

  // Load profile
  const { data, error } = await supabase
    .from('profiles')
    .select('name, bio, banner_url, logo_url, subdomain')
    .eq('id', userId)
    .single();

  if (error || !data) {
    alert("Profile not ready yet. Please wait a moment and refresh.");
    return;
  }

  profile = data;

  // Populate fields
  document.getElementById('creatorName').value = profile.name || '';
  document.getElementById('bioInput').value = profile.bio || '';
  document.getElementById('publicUrl').value = `https://rhythm-deck-music.onrender.com/public-profile.html?id=${profile.subdomain}`;

  if (profile.banner_url) document.getElementById('bannerPreview').src = supabase.storage.from('media').getPublicUrl(profile.banner_url).data.publicUrl;
  if (profile.logo_url) document.getElementById('logoPreview').src = supabase.storage.from('media').getPublicUrl(profile.logo_url).data.publicUrl;

  document.getElementById('previewLink').href = `/public-profile.html?id=${profile.subdomain}`;

  loadVideos();
}

// Upload file
async function uploadFile(file, path) {
  const { error } = await supabase.storage.from('media').upload(path, file, { upsert: true });
  if (error) throw error;
  return path;
}

// Load videos
async function loadVideos() {
  const { data } = await supabase.from('user_videos').select('*').eq('user_id', userId).order('created_at', { ascending: false });
  const grid = document.getElementById('videoGrid');
  grid.innerHTML = data?.length ? '' : '<p class="text-center text-xl text-gray-500 col-span-3">No videos yet — add your first!</p>';

  data?.forEach(v => {
    const videoUrl = supabase.storage.from('media').getPublicUrl(v.video_url).data.publicUrl;
    const thumbUrl = supabase.storage.from('media').getPublicUrl(v.thumbnail_url).data.publicUrl;

    const card = document.createElement('div');
    card.className = 'bg-white rounded-2xl shadow-xl overflow-hidden video-card group';
    card.innerHTML = `
      <img src="${thumbUrl}" class="w-full h-64 object-cover">
      <div class="play-overlay">Play</div>
      <div class="p-6">
        <h4 class="font-bold text-xl">${v.title || 'Untitled'}</h4>
        <button onclick="deleteVideo('${v.id}')" class="mt-4 text-red-600 font-bold">Delete</button>
      </div>
    `;
    card.onclick = () => window.open(videoUrl, '_blank');
    grid.appendChild(card);
  });
}

window.deleteVideo = async (id) => {
  if (!confirm('Delete this video forever?')) return;
  await supabase.from('user_videos').delete().eq('id', id);
  loadVideos();
};

// Event Listeners
document.getElementById('bannerInput').onchange = async e => {
  const file = e.target.files[0];
  if (!file) return;
  const path = `banners/${userId}_${Date.now()}.${file.name.split('.').pop()}`;
  await uploadFile(file, path);
  await supabase.from('profiles').update({ banner_url: path }).eq('id', userId);
  document.getElementById('bannerPreview').src = supabase.storage.from('media').getPublicUrl(path).data.publicUrl;
};

document.getElementById('logoInput').onchange = async e => {
  const file = e.target.files[0];
  if (!file) return;
  const path = `logos/${userId}_${Date.now()}.${file.name.split('.').pop()}`;
  await uploadFile(file, path);
  await supabase.from('profiles').update({ logo_url: path }).eq('id', userId);
  document.getElementById('logoPreview').src = supabase.storage.from('media').getPublicUrl(path).data.publicUrl;
};

document.getElementById('saveAllBtn').onclick = async () => {
  await supabase.from('profiles').update({
    name: document.getElementById('creatorName').value.trim(),
    bio: document.getElementById('bioInput').value.trim()
  }).eq('id', userId);
  alert("All saved!");
};

document.getElementById('openAddModal').onclick = () => document.getElementById('addModal').classList.remove('hidden');
document.getElementById('cancelAdd').onclick = () => document.getElementById('addModal').classList.add('hidden');

document.getElementById('saveVideoBtn').onclick = async () => {
  const thumb = document.getElementById('thumbFile').files[0];
  const video = document.getElementById('videoFile').files[0];
  const title = document.getElementById('videoTitle').value.trim();

  if (!thumb || !video) return alert("Please select both files");

  document.getElementById('uploadLoader').classList.remove('hidden');

  const thumbPath = `thumbnails/${userId}_${Date.now()}.${thumb.name.split('.').pop()}`;
  const videoPath = `videos/${userId}_${Date.now()}.mp4`;

  await uploadFile(thumb, thumbPath);
  await uploadFile(video, videoPath);

  await supabase.from('user_videos').insert({
    user_id: userId,
    title,
    thumbnail_url: thumbPath,
    video_url: videoPath
  });

  document.getElementById('addModal').classList.add('hidden');
  document.getElementById('uploadLoader').classList.add('hidden');
  loadVideos();
};

document.getElementById('copyUrl').onclick = () => {
  document.getElementById('publicUrl').select();
  document.execCommand('copy');
  alert("Copied to clipboard!");
};

// Start
init();
</script>
</body>
</html>