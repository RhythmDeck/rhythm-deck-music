<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rhythm Deck ‚Äî Profile Admin</title>

<!-- THIS ONE LINE FIXES ALL IMAGES ON EVERY PAGE FOREVER -->
  <base href="/">
  
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<style>
  .hover-change { opacity: 0; transition: opacity .18s ease; }
  .group:hover .hover-change { opacity: 1; }
  .play-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 2rem;
    color: white;
    pointer-events: none;
    opacity: 0.9;
  }
  .video-card { position: relative; cursor: pointer; }
</style>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="bg-black text-white p-4">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-4">
        <img src="logo-1-sm.jpg" alt="RD logo" class="h-10 w-10 object-contain">
        <div>
          <div class="text-xl font-bold">RHYTHM DECK MUSIC</div>
          <div class="text-sm text-gray-300">Unleash Your Beat</div>
        </div>
      </div>
      <nav class="space-x-4">
        <a href="index.html" class="hover:underline">Home</a>
        <a id="previewLink" href="#" class="hover:underline">Preview</a>
        <a href="signup.html" class="hover:underline">Upgrade</a>
        <a href="logout.html" class="bg-white text-black px-4 py-1 rounded hover:bg-gray-300">Logout</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-6">
    <section class="bg-white rounded-lg shadow p-6">
      <div class="relative group">
        <img id="bannerPreview" src="banner-placeholder.jpg" alt="Banner" class="w-full h-48 object-cover rounded-lg">
        <input id="bannerInput" type="file" accept="image/*" class="hidden">
        <div id="bannerPlus" class="hover-change absolute top-3 right-3 bg-black bg-opacity-70 text-white rounded-full w-9 h-9 flex items-center justify-center cursor-pointer text-2xl">+</div>
      </div>

      <div class="flex flex-col md:flex-row md:items-start gap-6 mt-6">
        <div class="relative group" style="min-width:150px;">
          <img id="logoPreview" src="logo-placeholder.png" alt="Logo" class="w-36 h-36 rounded-full object-cover border-4 border-white shadow">
          <input id="logoInput" type="file" accept="image/*" class="hidden">
          <div id="logoPlus" class="hover-change absolute -bottom-1 -right-1 bg-black bg-opacity-70 text-white rounded-full w-8 h-8 flex items-center justify-center cursor-pointer text-lg">+</div>
        </div>

        <div class="flex-1">
          <input id="creatorName" placeholder="Creator / Band Name" class="w-full text-2xl font-bold border-b pb-2 mb-2">
          <div id="bioContainer">
            <textarea id="bioInput" rows="4" placeholder="Write your bio..." class="w-full border rounded p-3 mb-2"></textarea>
            <button id="saveBioBtn" class="bg-black text-white px-4 py-2 rounded mb-2">Save Bio</button>
          </div>
          <div id="bioDisplay" class="hidden">
            <p id="bioText" class="p-3 border rounded mb-2 bg-gray-100"></p>
            <button id="editBioBtn" class="bg-black text-white px-4 py-2 rounded mb-2">Edit Bio</button>
          </div>
          <div class="mt-2 flex items-center gap-4">
            <button id="saveAllBtn" class="bg-green-600 text-white px-4 py-2 rounded">üíæ Save All</button>
            <button id="publishBtn" class="bg-blue-600 text-white px-4 py-2 rounded">üöÄ Publish</button>
            <div class="flex items-center gap-2">
              <span>Public URL:</span>
              <input id="publicUrl" class="border rounded p-1 text-sm w-60" readonly>
              <button id="copyUrl" class="bg-gray-300 px-2 py-1 rounded text-sm">Copy</button>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-8">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-semibold">Your Videos</h3>
          <button id="openAddModal" class="bg-black text-white px-4 py-2 rounded">+ Add Video</button>
        </div>
        <div id="videoGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mt-6"></div>
      </div>
    </section>
  </main>

  <div id="addModal" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-60 z-50">
    <div class="bg-white rounded-lg p-6 w-[420px]">
      <h4 class="text-lg font-semibold mb-3">Add New Video</h4>
      <label class="block text-sm font-medium mb-1">Choose Thumbnail</label>
      <input id="thumbFile" type="file" accept="image/*" class="mb-3 w-full">
      <label class="block text-sm font-medium mb-1">Choose Video (.mp4)</label>
      <input id="videoFile" type="file" accept="video/mp4" class="mb-3 w-full">
      <label class="block text-sm font-medium mb-1">Title (optional)</label>
      <input id="videoTitle" type="text" placeholder="Song or video title" class="w-full border rounded p-2 mb-4">
      <div class="flex gap-2">
        <button id="saveVideoBtn" class="bg-black text-white px-4 py-2 rounded flex-1">Save Video</button>
        <button id="cancelAdd" class="bg-gray-200 px-4 py-2 rounded flex-1">Cancel</button>
      </div>
      <div id="uploadLoader" class="hidden text-center mt-2">Uploading... <span class="animate-spin inline-block">‚è≥</span></div>
    </div>
  </div>

  <footer class="bg-black text-white mt-10 py-6">
    <div class="max-w-6xl mx-auto text-center">
      <div class="mb-2">
        <a href="privacy.html" class="text-gray-300 hover:text-white mx-2">Privacy Policy</a>
        <a href="terms.html" class="text-gray-300 hover:text-white mx-2">Terms & Conditions</a>
      </div>
      <div class="text-sm text-gray-400">¬© 2025 Rhythm Deck Music</div>
    </div>
  </footer>

<script>
const SUPABASE_URL = "https://bxoqhmfnseskwqkywppg.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4b3FobWZuc2Vza3dxa3l3cHBnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5Mjk4MzgsImV4cCI6MjA3NjUwNTgzOH0.vnzlMkgkA0bOpFSw2JN_b3GjrxWK3S85yC1WGeoOUZc";
const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let userId = null;
let profileData = { name: '', bio: '', banner: '', logo: '', publicUrl: '', subdomain: '' };
let videos = [];

const bannerPreview = document.getElementById('bannerPreview');
const logoPreview = document.getElementById('logoPreview');
const bannerInput = document.getElementById('bannerInput');
const logoInput = document.getElementById('logoInput');
const creatorName = document.getElementById('creatorName');
const bioInput = document.getElementById('bioInput');
const saveBioBtn = document.getElementById('saveBioBtn');
const bioDisplay = document.getElementById('bioDisplay');
const bioText = document.getElementById('bioText');
const editBioBtn = document.getElementById('editBioBtn');
const videoGrid = document.getElementById('videoGrid');
const saveAllBtn = document.getElementById('saveAllBtn');
const publishBtn = document.getElementById('publishBtn');
const publicUrlInput = document.getElementById('publicUrl');
const copyUrlBtn = document.getElementById('copyUrl');
const previewLink = document.getElementById('previewLink');
const addModal = document.getElementById('addModal');
const openAddBtn = document.getElementById('openAddModal');
const cancelAdd = document.getElementById('cancelAdd');
const saveVideoBtn = document.getElementById('saveVideoBtn');
const thumbFile = document.getElementById('thumbFile');
const videoFile = document.getElementById('videoFile');
const videoTitle = document.getElementById('videoTitle');
const uploadLoader = document.getElementById('uploadLoader');

async function uploadToStorage(file, path) {
  const { data, error } = await supabase.storage.from('user-media').upload(path, file);
  if (error) throw error;
  return data.path;
}

function getPublicUrl(path) {
  const { data } = supabase.storage.from('user-media').getPublicUrl(path);
  return data.publicUrl;
}

function updatePreviewLink() {
  const url = profileData.publicUrl || '#';
  previewLink.href = url;
  previewLink.textContent = profileData.publicUrl ? 'Preview' : 'Preview (Publish First)';
  publicUrlInput.value = profileData.publicUrl;
}

async function loadProfile() {
  const { data: { user }, error: authError } = await supabase.auth.getUser();
  if (authError || !user) {
    alert('Please log in to access this page.');
    window.location.href = 'login.html';
    return;
  }
  userId = user.id;

  const { data: profile, error: profileError } = await supabase
    .from('profiles')
    .select('name, bio, banner, logo, public_url, subdomain')
    .eq('id', userId)
    .single();
  if (profileError) {
    console.error(profileError);
    return;
  }
  if (profile) {
    profileData = {
      name: profile.name || '',
      bio: profile.bio || '',
      banner: profile.banner ? getPublicUrl(profile.banner) : 'banner-placeholder.jpg',
      logo: profile.logo ? getPublicUrl(profile.logo) : 'logo-placeholder.png',
      publicUrl: profile.public_url || '',
      subdomain: profile.subdomain || ''
    };
  }

  bannerPreview.src = profileData.banner;
  logoPreview.src = profileData.logo;
  creatorName.value = profileData.name;
  if (profileData.bio) {
    bioText.textContent = profileData.bio;
    bioInput.value = profileData.bio;
    bioDisplay.classList.remove('hidden');
    document.getElementById('bioContainer').classList.add('hidden');
  }
  updatePreviewLink();

  const { data: videoData, error: videoError } = await supabase
    .from('videos')
    .select('*')
    .eq('user_id', userId)
    .order('created_at', { ascending: false });
  if (videoError) {
    console.error(videoError);
    return;
  }
  videos = videoData || [];
  videos.forEach(v => {
    v.thumbnail = getPublicUrl(v.thumbnail_path);
    v.video_url = getPublicUrl(v.video_path);
  });
  renderVideos();
}
document.addEventListener('DOMContentLoaded', loadProfile);

document.getElementById('bannerPlus').addEventListener('click', () => bannerInput.click());
bannerInput.addEventListener('change', async e => {
  const file = e.target.files[0];
  if (!file) return;
  try {
    const path = `${userId}/banner.${file.name.split('.').pop()}`;
    await uploadToStorage(file, path);
    profileData.banner = getPublicUrl(path);
    bannerPreview.src = profileData.banner;
  } catch (err) {
    alert('Error uploading banner: ' + err.message);
  }
});

document.getElementById('logoPlus').addEventListener('click', () => logoInput.click());
logoInput.addEventListener('change', async e => {
  const file = e.target.files[0];
  if (!file) return;
  try {
    const path = `${userId}/logo.${file.name.split('.').pop()}`;
    await uploadToStorage(file, path);
    profileData.logo = getPublicUrl(path);
    logoPreview.src = profileData.logo;
  } catch (err) {
    alert('Error uploading logo: ' + err.message);
  }
});

saveBioBtn.addEventListener('click', () => {
  profileData.bio = bioInput.value.trim();
  bioText.textContent = profileData.bio;
  bioDisplay.classList.remove('hidden');
  document.getElementById('bioContainer').classList.add('hidden');
});
editBioBtn.addEventListener('click', () => {
  document.getElementById('bioContainer').classList.remove('hidden');
  bioDisplay.classList.add('hidden');
});

openAddBtn.addEventListener('click', () => {
  thumbFile.value = ''; videoFile.value = ''; videoTitle.value = '';
  addModal.classList.remove('hidden');
});
cancelAdd.addEventListener('click', () => addModal.classList.add('hidden'));

saveVideoBtn.addEventListener('click', async () => {
  const tFile = thumbFile.files[0];
  const vFile = videoFile.files[0];
  if (!tFile || !vFile) return alert('Choose thumbnail & video.');
  uploadLoader.classList.remove('hidden');
  saveVideoBtn.disabled = true;
  cancelAdd.disabled = true;
  try {
    const videoId = Date.now();
    const thumbPath = `${userId}/thumbnails/${videoId}.${tFile.name.split('.').pop()}`;
    const videoPath = `${userId}/videos/${videoId}.mp4`;
    await uploadToStorage(tFile, thumbPath);
    await uploadToStorage(vFile, videoPath);
    const meta = {
      id: videoId,
      title: videoTitle.value.trim(),
      thumbnail_path: thumbPath,
      video_path: videoPath,
      thumbnail: getPublicUrl(thumbPath),
      video_url: getPublicUrl(videoPath),
      created_at: new Date().toISOString(),
      likes: 0,
      subscribes: 0,
      shares: 0
    };
    const { error } = await supabase.from('videos').insert([{ ...meta, user_id: userId }]);
    if (error) throw error;
    videos.unshift(meta);
    renderVideos();
    addModal.classList.add('hidden');
  } catch (err) {
    alert('Error saving video: ' + err.message);
  } finally {
    uploadLoader.classList.add('hidden');
    saveVideoBtn.disabled = false;
    cancelAdd.disabled = false;
  }
});

function renderVideos() {
  videoGrid.innerHTML = '';
  if (!videos.length) {
    videoGrid.innerHTML = '<div class="text-gray-600">No videos yet ‚Äî click Add Video to upload.</div>';
    return;
  }
  videos.forEach((m, idx) => {
    const card = document.createElement('div');
    card.className = 'bg-gray-100 rounded overflow-hidden relative video-card';
    card.innerHTML = `
      <div class="w-full aspect-video overflow-hidden relative">
        <img src="${m.thumbnail}" class="w-full h-full object-cover" data-index="${idx}">
        <div class="play-overlay">‚ñ∂</div>
      </div>
      <div class="p-3 flex justify-between items-center">
        <div>
          <div class="font-semibold">${m.title || 'Untitled'}</div>
          <div class="text-xs text-gray-500">${new Date(m.created_at).toLocaleString()}</div>
          <div class="flex gap-2 text-sm mt-1">
            <span>üëç ${m.likes}</span> <span>üîî ${m.subscribes}</span> <span>üîó ${m.shares}</span>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button data-idx="${idx}" class="text-sm text-red-600 bg-white px-2 py-1 rounded border delete-btn">Delete</button>
          <button data-url="${m.video_url}" class="text-sm text-white bg-black px-3 py-1 rounded play-btn">Play</button>
        </div>
      </div>
    `;
    videoGrid.appendChild(card);

    card.querySelector('.play-btn').addEventListener('click', (ev) => {
      const url = ev.currentTarget.getAttribute('data-url');
      openPreviewModal(url);
    });
    card.querySelector('.delete-btn').addEventListener('click', async (ev) => {
      const i = parseInt(ev.currentTarget.getAttribute('data-idx'), 10);
      const removed = videos.splice(i, 1)[0];
      try {
        await supabase.from('videos').delete().eq('id', removed.id).eq('user_id', userId);
        await supabase.storage.from('user-media').remove([removed.thumbnail_path, removed.video_path]);
      } catch (e) {
        console.warn(e);
      }
      renderVideos();
    });
    card.querySelector('img').addEventListener('click', (ev) => {
      const i = parseInt(ev.currentTarget.getAttribute('data-index'), 10);
      openPreviewModal(videos[i].video_url);
    });
  });
}

function openPreviewModal(url) {
  const overlay = document.createElement('div');
  overlay.className = 'fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-60';
  overlay.innerHTML = `
    <div class="bg-black rounded-md overflow-hidden flex items-center justify-center p-4 w-[90%] max-w-[1280px]">
      <video controls autoplay src="${url}" style="width:70%;height:70%;"></video>
      <button class="text-white bg-gray-800 px-3 py-1 rounded absolute top-4 right-4 close-btn">Close</button>
    </div>
  `;
  overlay.querySelector('.close-btn').onclick = () => {
    const vid = overlay.querySelector('video');
    vid.pause();
    overlay.remove();
  };
  document.body.appendChild(overlay);
}

copyUrlBtn.addEventListener('click', () => {
  publicUrlInput.select();
  document.execCommand('copy');
  alert('URL copied to clipboard');
});

saveAllBtn.addEventListener('click', async () => {
  if (!creatorName.value.trim()) return alert('Enter a name.');
  profileData.name = creatorName.value.trim();
  try {
    const updates = {
      name: profileData.name,
      bio: profileData.bio
    };
    if (profileData.banner && !profileData.banner.includes('placeholder')) {
      updates.banner = new URL(profileData.banner).pathname.substring(1);
    }
    if (profileData.logo && !profileData.logo.includes('placeholder')) {
      updates.logo = new URL(profileData.logo).pathname.substring(1);
    }
    const { error } = await supabase
      .from('profiles')
      .update(updates)
      .eq('id', userId);
    if (error) throw error;
    alert('All changes saved!');
  } catch (e) {
    alert('Error saving: ' + e.message);
  }
});

publishBtn.addEventListener('click', async () => {
  if (!profileData.name || !profileData.banner || !profileData.logo || !profileData.subdomain) return alert('Fill name, banner, logo, and ensure subdomain is set.');
  try {
    profileData.publicUrl = `https://${profileData.subdomain}.rhythm-deck.wasmer.app/`;
    // If subdomains not supported: profileData.publicUrl = `https://rhythm-deck.wasmer.app/u/${profileData.subdomain}`;
    const { error } = await supabase
      .from('profiles')
      .update({ public_url: profileData.publicUrl })
      .eq('id', userId);
    if (error) throw error;
    updatePreviewLink();
    alert('Profile published! URL: ' + profileData.publicUrl);
  } catch (e) {
    alert('Error publishing: ' + e.message);
  }
});
</script>

<script>
  const SUPABASE_URL = "https://bxoqhmfnseskwqkywppg.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4b3FobWZuc2Vza3dxa3l3cHBnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5Mjk4MzgsImV4cCI6MjA3NjUwNTgzOH0.vnzlMkgkA0bOpFSw2JN_b3GjrxWK3S85yC1WGeoOUZc";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  async function loadSubdomain() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      window.location.href = "login.html";
      return;
    }

    const { data: profile, error } = await supabase
      .from('profiles')
      .select('subdomain')
      .eq('id', user.id)
      .single();

    if (error || !profile) {
      console.error('No profile found');
      return;
    }

    // Display in "Public URL" section (replace 'publicUrl' with your ID if different)
    document.getElementById('publicUrl').textContent = `${window.location.origin}/artist/${profile.subdomain}`;
  }

  loadSubdomain();
</script>
</body>
</html>